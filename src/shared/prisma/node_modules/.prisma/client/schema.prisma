// ============================================================
// SSU Student Dashboard - Prisma Schema
// Based on shared/mockData types
// ============================================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================
// User & Authentication Models
// ============================================================

enum UserRole {
  STUDENT
  PROFESSOR
  ADMIN
  SUPER_ADMIN
}

enum UserStatus {
  ACTIVE
  INACTIVE
}

model User {
  id         Int        @id @default(autoincrement())
  email      String     @unique
  name       String
  password   String
  role       UserRole   @default(STUDENT)
  status     UserStatus @default(ACTIVE)
  department String
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt

  // Relations
  student        Student?
  professor      Professor?
  loginHistories LoginHistory[]
  notifications  Notification[]

  @@map("users")
}

model Student {
  id         Int      @id @default(autoincrement())
  userId     Int      @unique
  studentId  String   @unique // 학번
  grade      String // 학년 (1학년, 2학년, 3학년, 4학년)
  totalScore Float    @default(0)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  user                  User                   @relation(fields: [userId], references: [id], onDelete: Cascade)
  competencyScores      CompetencyScore[]
  evidences             Evidence[]
  complaints            Complaint[]
  jobFitRecommendations JobFitRecommendation[]

  @@map("students")
}

model Professor {
  id         Int      @id @default(autoincrement())
  userId     Int      @unique
  employeeId String   @unique // 교번
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  courses Course[]

  @@map("professors")
}

model LoginHistory {
  id        Int      @id @default(autoincrement())
  userId    Int
  device    String
  ipAddress String?
  createdAt DateTime @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("login_histories")
}

// ============================================================
// Competency Models (STAR 역량)
// ============================================================

enum CompetencyType {
  S // 창의역량
  T // 실무역량
  A // 인성역량
  R // 소통역량
}

enum CompetencyGrade {
  MASTER // 마스터
  EXCELLENT // 우수
  AVERAGE // 보통
  NEEDS_WORK // 노력요망
}

model Competency {
  id          Int            @id @default(autoincrement())
  type        CompetencyType @unique
  name        String // 역량명 (창의역량, 실무역량, 인성역량, 소통역량)
  description String?
  color       String // UI 표시 색상
  skills      String[] // 하위 스킬 목록
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  // Relations
  competencyScores CompetencyScore[]
  poDetails        PODetail[]
  courses          Course[]
  evidences        Evidence[]

  @@map("competencies")
}

model CompetencyScore {
  id           Int             @id @default(autoincrement())
  studentId    Int
  competencyId Int
  score        Float
  grade        CompetencyGrade
  semester     String // 학기 (2024-1학기, 2024-2학기, 2025-여름학기)
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt

  // Relations
  student    Student    @relation(fields: [studentId], references: [id], onDelete: Cascade)
  competency Competency @relation(fields: [competencyId], references: [id])

  @@unique([studentId, competencyId, semester])
  @@map("competency_scores")
}

model PODetail {
  id           Int             @id @default(autoincrement())
  name         String          @unique // 전공능력명
  competencyId Int
  score        Float           @default(0)
  grade        CompetencyGrade @default(AVERAGE)
  skills       String[]
  color        String
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt

  // Relations
  competency Competency @relation(fields: [competencyId], references: [id])

  @@map("po_details")
}

// ============================================================
// Course Models
// ============================================================

model Course {
  id           Int      @id @default(autoincrement())
  code         String? // 과목 코드
  name         String
  semester     String // 학기
  totalWeeks   Int      @default(15)
  students     Int      @default(0) // 수강생 수
  avgScore     Float?
  professorId  Int?
  competencyId Int?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  professor      Professor?      @relation(fields: [professorId], references: [id])
  competency     Competency?     @relation(fields: [competencyId], references: [id])
  weeklyLectures WeeklyLecture[]
  evidences      Evidence[]

  @@map("courses")
}

model WeeklyLecture {
  id         Int      @id @default(autoincrement())
  courseId   Int
  week       Int
  date       String
  day        String
  title      String
  status     String   @default("예정") // 완료, 진행중, 예정
  attendance Int      @default(0)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  course Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([courseId, week])
  @@map("weekly_lectures")
}

// ============================================================
// Evidence Models
// ============================================================

model Evidence {
  id           Int      @id @default(autoincrement())
  studentId    Int
  courseId     Int?
  competencyId Int?
  task         String // 과제명
  score        String // A+, A, B+ 등
  semester     String
  date         String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  student    Student     @relation(fields: [studentId], references: [id], onDelete: Cascade)
  course     Course?     @relation(fields: [courseId], references: [id])
  competency Competency? @relation(fields: [competencyId], references: [id])

  @@map("evidences")
}

// ============================================================
// Complaint Models
// ============================================================

enum ComplaintStatus {
  RECEIVED // 접수
  PROCESSING // 처리중
  COMPLETED // 완료
  REJECTED // 반려됨
}

enum ComplaintPriority {
  HIGH
  MEDIUM
  LOW
}

model ComplaintCategory {
  id        Int      @id @default(autoincrement())
  name      String   @unique
  icon      String
  color     String
  items     String[] // 세부 항목
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  complaints Complaint[]
  faqs       FAQ[]
  templates  ComplaintTemplate[]

  @@map("complaint_categories")
}

model Complaint {
  id             Int               @id @default(autoincrement())
  studentId      Int
  categoryId     Int
  title          String
  content        String
  status         ComplaintStatus   @default(RECEIVED)
  priority       ComplaintPriority @default(MEDIUM)
  currentStep    Int               @default(1)
  department     String?
  assigneeId     Int?
  adminResponse  String?
  responseDate   DateTime?
  isRead         Boolean           @default(false)
  isRated        Boolean           @default(false)
  rating         Int?
  rejectedReason String?
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt

  // Relations
  student     Student               @relation(fields: [studentId], references: [id], onDelete: Cascade)
  category    ComplaintCategory     @relation(fields: [categoryId], references: [id])
  attachments ComplaintAttachment[]
  replies     ComplaintReply[]

  @@map("complaints")
}

model ComplaintAttachment {
  id          Int      @id @default(autoincrement())
  complaintId Int
  name        String
  size        String
  url         String
  createdAt   DateTime @default(now())

  // Relations
  complaint Complaint @relation(fields: [complaintId], references: [id], onDelete: Cascade)

  @@map("complaint_attachments")
}

model ComplaintReply {
  id          Int      @id @default(autoincrement())
  complaintId Int
  content     String
  author      String
  createdAt   DateTime @default(now())

  // Relations
  complaint Complaint @relation(fields: [complaintId], references: [id], onDelete: Cascade)

  @@map("complaint_replies")
}

model ComplaintTemplate {
  id         Int      @id @default(autoincrement())
  categoryId Int
  title      String
  content    String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  category ComplaintCategory @relation(fields: [categoryId], references: [id])

  @@map("complaint_templates")
}

// ============================================================
// Notification Models
// ============================================================

model Notification {
  id        Int      @id @default(autoincrement())
  userId    Int
  title     String
  message   String
  read      Boolean  @default(false)
  createdAt DateTime @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notifications")
}

// ============================================================
// FAQ Models
// ============================================================

model FAQ {
  id         Int      @id @default(autoincrement())
  categoryId Int?
  question   String
  answer     String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  category ComplaintCategory? @relation(fields: [categoryId], references: [id])

  @@map("faqs")
}

// ============================================================
// Job Fit Models
// ============================================================

model JobFitRecommendation {
  id        Int      @id @default(autoincrement())
  studentId Int
  jobName   String
  matchRate Float
  grade     String // 우수, 보통, 미흡
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@map("job_fit_recommendations")
}

// ============================================================
// Chat Models
// ============================================================

model ChatSession {
  id        Int      @id @default(autoincrement())
  sessionId String   @unique
  category  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  messages ChatMessage[]

  @@map("chat_sessions")
}

model ChatMessage {
  id        Int      @id @default(autoincrement())
  sessionId Int
  type      String // bot, user
  message   String
  createdAt DateTime @default(now())

  // Relations
  session ChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@map("chat_messages")
}

model ChatbotTemplate {
  id        Int      @id @default(autoincrement())
  category  String
  key       String
  template  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([category, key])
  @@map("chatbot_templates")
}

// ============================================================
// App Configuration
// ============================================================

model AppConfig {
  id        Int      @id @default(autoincrement())
  key       String   @unique
  value     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("app_configs")
}
