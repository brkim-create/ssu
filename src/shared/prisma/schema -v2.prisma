// ============================================================
// SSU Student Dashboard - Prisma Schema
// Based on shared/mockData types
// ============================================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================
// User & Authentication Models
// ============================================================

enum UserRole {
  STUDENT
  PROFESSOR
  ADMIN
  SUPER_ADMIN
}

enum UserStatus {
  ACTIVE
  INACTIVE
}

model User {
  id          Int        @id @default(autoincrement())
  email       String     @unique
  name        String
  password    String
  role        UserRole   @default(STUDENT)
  status      UserStatus @default(ACTIVE)
  department  String
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  // Relations
  student        Student?
  professor      Professor?
  loginHistories LoginHistory[]

  @@map("users")
}

model Student {
  id          Int      @id @default(autoincrement())
  userId      Int      @unique
  studentId   String   @unique // 학번
  grade       String   // 학년 (1학년, 2학년, 3학년, 4학년)
  totalScore  Float    @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  user                   User                   @relation(fields: [userId], references: [id], onDelete: Cascade)
  competencyScores       CompetencyScore[]
  evidences              Evidence[]
  jobFitRecommendations  JobFitRecommendation[]
  underperformingRecords UnderperformingStudent[]

  @@map("students")
}

model Professor {
  id          Int      @id @default(autoincrement())
  userId      Int      @unique
  employeeId  String   @unique // 교번
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  courses Course[]

  @@map("professors")
}

model LoginHistory {
  id        Int      @id @default(autoincrement())
  userId    Int
  device    String
  ipAddress String?
  createdAt DateTime @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("login_histories")
}

// ============================================================
// Competency Models (STAR 역량)
// ============================================================

enum CompetencyType {
  S // 창의역량
  T // 실무역량
  A // 인성역량
  R // 소통역량
}

enum CompetencyGrade {
  MASTER     // 마스터
  EXCELLENT  // 우수
  AVERAGE    // 보통
  NEEDS_WORK // 노력요망
}

model Competency {
  id          Int            @id @default(autoincrement())
  type        CompetencyType @unique
  name        String         // 역량명 (창의역량, 실무역량, 인성역량, 소통역량)
  description String?
  color       String         // UI 표시 색상
  skills      String[]       // 하위 스킬 목록
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  // Relations
  competencyScores CompetencyScore[]
  poDetails        PODetail[]
  courses          Course[]
  evidences        Evidence[]

  @@map("competencies")
}

model CompetencyScore {
  id           Int             @id @default(autoincrement())
  studentId    Int
  competencyId Int
  score        Float
  grade        CompetencyGrade
  semester     String          // 학기 (2024-1학기, 2024-2학기, 2025-여름학기)
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt

  // Relations
  student    Student    @relation(fields: [studentId], references: [id], onDelete: Cascade)
  competency Competency @relation(fields: [competencyId], references: [id])

  @@unique([studentId, competencyId, semester])
  @@map("competency_scores")
}

model PODetail {
  id           Int             @id @default(autoincrement())
  name         String          @unique // 전공능력명
  competencyId Int
  score        Float           @default(0)
  grade        CompetencyGrade @default(AVERAGE)
  skills       String[]
  color        String
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt

  // Relations
  competency Competency @relation(fields: [competencyId], references: [id])

  @@map("po_details")
}

// ============================================================
// Course Models
// ============================================================

model Course {
  id           Int            @id @default(autoincrement())
  code         String?        // 과목 코드
  name         String
  semester     String         // 학기
  totalWeeks   Int            @default(15)
  students     Int            @default(0) // 수강생 수
  avgScore     Float?
  professorId  Int?
  competencyId Int?
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt

  // Relations
  professor      Professor?      @relation(fields: [professorId], references: [id])
  competency     Competency?     @relation(fields: [competencyId], references: [id])
  weeklyLectures WeeklyLecture[]
  evidences      Evidence[]

  @@map("courses")
}

model WeeklyLecture {
  id         Int      @id @default(autoincrement())
  courseId   Int
  week       Int
  date       String
  day        String
  title      String
  status     String   @default("예정") // 완료, 진행중, 예정
  attendance Int      @default(0)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  course Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([courseId, week])
  @@map("weekly_lectures")
}

// ============================================================
// Evidence Models
// ============================================================

model Evidence {
  id           Int      @id @default(autoincrement())
  studentId    Int
  courseId     Int?
  competencyId Int?
  task         String   // 과제명
  score        String   // A+, A, B+ 등
  semester     String
  date         String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  student    Student     @relation(fields: [studentId], references: [id], onDelete: Cascade)
  course     Course?     @relation(fields: [courseId], references: [id])
  competency Competency? @relation(fields: [competencyId], references: [id])

  @@map("evidences")
}

// ============================================================
// Job Fit Models
// ============================================================

model JobFitRecommendation {
  id         Int      @id @default(autoincrement())
  studentId  Int
  jobName    String
  matchRate  Float
  grade      String   // 우수, 보통, 미흡
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@map("job_fit_recommendations")
}

// ============================================================
// Chat Models
// ============================================================

model ChatSession {
  id         Int           @id @default(autoincrement())
  sessionId  String        @unique
  category   String
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt

  // Relations
  messages ChatMessage[]

  @@map("chat_sessions")
}

model ChatMessage {
  id        Int      @id @default(autoincrement())
  sessionId Int
  type      String   // bot, user
  message   String
  createdAt DateTime @default(now())

  // Relations
  session ChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@map("chat_messages")
}

model ChatbotTemplate {
  id        Int      @id @default(autoincrement())
  category  String
  key       String
  template  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([category, key])
  @@map("chatbot_templates")
}

// ============================================================
// App Configuration
// ============================================================

model AppConfig {
  id        Int      @id @default(autoincrement())
  key       String   @unique
  value     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("app_configs")
}

// ============================================================
// Behavior Indicator Models (18개 행동지표)
// ============================================================

enum IndicatorStatus {
  EXCELLENT
  GOOD
  POOR
}

model BehaviorIndicator {
  id          Int             @id @default(autoincrement())
  code        String          @unique // BI-01, BI-02, ...
  name        String          // 기획, 실행, 화합, 통섭, ...
  competencyType CompetencyType // S, T, A, R
  description String?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  // Relations
  scores BehaviorIndicatorScore[]

  @@map("behavior_indicators")
}

model BehaviorIndicatorScore {
  id           Int             @id @default(autoincrement())
  indicatorId  Int
  departmentId Int?
  studentId    Int?
  achievement  Float           // 0-100
  status       IndicatorStatus
  semester     String
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt

  // Relations
  indicator  BehaviorIndicator @relation(fields: [indicatorId], references: [id])
  department Department?       @relation(fields: [departmentId], references: [id])

  @@map("behavior_indicator_scores")
}

// ============================================================
// Department Models (학과)
// ============================================================

model Department {
  id        Int      @id @default(autoincrement())
  name      String   @unique
  college   String?  // 소속 단과대학
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  heatmapScores      DepartmentHeatmapScore[]
  cqiStatuses        CQIStatus[]
  departmentGaps     DepartmentGap[]
  indicatorScores    BehaviorIndicatorScore[]

  @@map("departments")
}

// ============================================================
// Department Heatmap Models (과별 역량 히트맵)
// ============================================================

model DepartmentHeatmapScore {
  id           Int      @id @default(autoincrement())
  departmentId Int
  semester     String
  // 18개 행동지표 점수 (S: 창의역량)
  planning     Float    @default(0) @map("기획")
  execution    Float    @default(0) @map("실행")
  harmony      Float    @default(0) @map("화합")
  convergence  Float    @default(0) @map("통섭")
  // T: 실무역량
  majorKnowledge    Float @default(0) @map("전공지식")
  majorSkill        Float @default(0) @map("전공기술")
  informatics       Float @default(0) @map("정보화")
  newTechUtilization Float @default(0) @map("신기술활용")
  empathy           Float @default(0) @map("공감")
  judgment          Float @default(0) @map("판단")
  // A: 인성역량
  mission           Float @default(0) @map("사명감")
  orgUnderstanding  Float @default(0) @map("조직이해")
  challenge         Float @default(0) @map("도전성")
  selfLearning      Float @default(0) @map("자기학습")
  // R: 소통역량
  listening         Float @default(0) @map("경청")
  negotiation       Float @default(0) @map("협상")
  foreignLanguage   Float @default(0) @map("외국어")
  globalCitizen     Float @default(0) @map("세계시민")
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  department Department @relation(fields: [departmentId], references: [id])

  @@unique([departmentId, semester])
  @@map("department_heatmap_scores")
}

// ============================================================
// Teaching Method Models (교수법)
// ============================================================

model TeachingMethod {
  id          Int      @id @default(autoincrement())
  name        String   @unique // PBL, Flipped Learning, 강의식, ...
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  diagnostics TeachingMethodDiagnostic[]

  @@map("teaching_methods")
}

model TeachingMethodDiagnostic {
  id              Int      @id @default(autoincrement())
  methodId        Int
  courseId        Int?
  semester        String
  score           Float    // 전체 점수
  S               Float    @default(0) // S역량 점수
  T               Float    @default(0)
  A               Float    @default(0)
  R               Float    @default(0)
  satisfaction    Float?   // 만족도
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  method TeachingMethod @relation(fields: [methodId], references: [id])

  @@map("teaching_method_diagnostics")
}

// ============================================================
// CQI Models (CQI 운영 현황)
// ============================================================

model CQIStatus {
  id           Int      @id @default(autoincrement())
  departmentId Int
  semester     String
  totalCourses Int      @default(0) // 전체 교과목 수
  completed    Int      @default(0) // CQI 완료 수
  rate         Float    @default(0) // 완료율 (%)
  lowGrade     Int      @default(0) // 미흡 학점 수
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  department Department @relation(fields: [departmentId], references: [id])

  @@unique([departmentId, semester])
  @@map("cqi_statuses")
}

model CQIPerformance {
  id                   Int      @id @default(autoincrement())
  semester             String   @unique
  targetAchievement    Float    // 목표 달성률
  currentAchievement   Float    // 현재 달성률
  achievementRate      Float    // 달성률 (%)
  yearOverYear         Float    // 전년 대비 (%)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  // Relations
  weakAreas CQIWeakArea[]

  @@map("cqi_performances")
}

model CQIWeakArea {
  id            Int      @id @default(autoincrement())
  performanceId Int
  area          String   // 약점 영역명
  score         Float
  improvement   String?  // 개선 방안
  createdAt     DateTime @default(now())

  // Relations
  performance CQIPerformance @relation(fields: [performanceId], references: [id], onDelete: Cascade)

  @@map("cqi_weak_areas")
}

// ============================================================
// Department Gap Analysis (과별 역량 Gap 분석)
// ============================================================

model DepartmentGap {
  id           Int      @id @default(autoincrement())
  departmentId Int
  semester     String
  current      Float    // 현재 수준
  target       Float    // 목표 수준
  gap          Float    // Gap (target - current)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  department Department @relation(fields: [departmentId], references: [id])

  @@unique([departmentId, semester])
  @@map("department_gaps")
}

// ============================================================
// Underperforming Student (역량 미달 학생)
// ============================================================

model UnderperformingStudent {
  id           Int            @id @default(autoincrement())
  studentId    Int
  targetComp   CompetencyType // 미달 역량
  score        Float          // 현재 점수
  threshold    Float          // 기준 점수
  gap          Float          // Gap (threshold - score)
  semester     String
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt

  // Relations
  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([studentId, targetComp, semester])
  @@map("underperforming_students")
}

// ============================================================
// Certification (인증 현황)
// ============================================================

model Certification {
  id        Int      @id @default(autoincrement())
  level     String   // 1단계, 2단계, 3단계, ...
  name      String   // 인증 단계명
  count     Int      @default(0) // 해당 단계 학생 수
  color     String   // UI 표시 색상
  semester  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([level, semester])
  @@map("certifications")
}

// ============================================================
// Assessment Tool (평가 도구별 역량)
// ============================================================

model AssessmentTool {
  id        Int      @id @default(autoincrement())
  name      String   @unique // 중간고사, 기말고사, 프로젝트, ...
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  scores AssessmentToolScore[]

  @@map("assessment_tools")
}

model AssessmentToolScore {
  id         Int      @id @default(autoincrement())
  toolId     Int
  courseId   Int?
  semester   String
  S          Float    @default(0)
  T          Float    @default(0)
  A          Float    @default(0)
  R          Float    @default(0)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  tool AssessmentTool @relation(fields: [toolId], references: [id])

  @@map("assessment_tool_scores")
}

// ============================================================
// Statistics & Chart Models (통계/차트 데이터)
// ============================================================

// 성취도 히스토그램 (교과목별 점수 분포)
model HistogramData {
  id         Int      @id @default(autoincrement())
  courseId   Int?
  semester   String
  range      String   // "0-20", "21-40", "41-60", "61-80", "81-100"
  students   Int      @default(0)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([courseId, semester, range])
  @@map("histogram_data")
}

// 성취도 분포 (전체/학과별)
model AchievementDistribution {
  id           Int      @id @default(autoincrement())
  departmentId Int?
  semester     String
  range        String   // "0-20", "21-40", ...
  count        Int      @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@unique([departmentId, semester, range])
  @@map("achievement_distributions")
}

// 역량 추이 (연도별)
model CompetencyTrend {
  id        Int      @id @default(autoincrement())
  year      String   // "2022", "2023", "2024"
  S         Float    @default(0)
  T         Float    @default(0)
  A         Float    @default(0)
  R         Float    @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([year])
  @@map("competency_trends")
}

// 학년별 성장 데이터
model GradeGrowth {
  id        Int      @id @default(autoincrement())
  semester  String
  grade     String   // "1학년", "2학년", "3학년", "4학년"
  S         Float    @default(0)
  T         Float    @default(0)
  A         Float    @default(0)
  R         Float    @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([semester, grade])
  @@map("grade_growths")
}

// 레이더 차트 데이터 (학생/학과/전체 평균 비교)
model RadarData {
  id           Int      @id @default(autoincrement())
  studentId    Int?
  departmentId Int?
  semester     String
  subject      String   // 역량명
  myScore      Float    @default(0)
  deptAvg      Float    @default(0)
  totalAvg     Float    @default(0)
  fullMark     Float    @default(100)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@unique([studentId, departmentId, semester, subject])
  @@map("radar_data")
}

// 역량 분포 (admin-ds)
model CompetencyDistribution {
  id           Int            @id @default(autoincrement())
  departmentId Int?
  semester     String
  competency   CompetencyType
  count        Int            @default(0)
  percentage   Float          @default(0)
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt

  @@unique([departmentId, semester, competency])
  @@map("competency_distributions")
}
